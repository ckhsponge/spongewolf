require 'mt-capistrano'
 
set :site,         "1727"
set :application,  "spongewolf"
set :webpath,      "spongewolf.com"
set :domain,       "spongecorp.com"
set :user,         "serveradmin%spongecorp.com"
set :password,     "wKnAgM68"
 
#ssh_options[:username] = 'serveradmin%primarydomain.com'
 
set :svn_username, 'cap'
set :svn_password, 'ndep1m3s'
set :repository, "https://spongecell.svn.engineyard.com/dev/spongewolf"
#set :repository, "svn+ssh://#{user}@#{domain}/home/#{site}/data/svn/#{application}/trunk"
set :deploy_to,  "/home/#{site}/containers/rails/#{application}"
set :current_deploy_dir, "#{deploy_to}/current"
set :tmp_dir, "#{deploy_to}/tmp"
 
set :checkout, "export"
 
role :web, "#{domain}"
role :app, "#{domain}"
role :db,  "#{domain}", :primary => true
 
task :after_update_code, :roles => :app do
  put(File.read('config/database.yml'), "#{release_path}/config/database.yml", :mode => 0444)
  tar_source
end

task :tar_source, :roles => :app do
  run "cd #{release_path} && mkdir -p #{tmp_dir} && mkdir #{tmp_dir}/spongewolf && cp -R * #{tmp_dir}/spongewolf"
  run "cd #{tmp_dir} && tar -czf spongewolf.tar.gz --exclude spongewolf/vendor/rails --exclude spongewolf/config/deploy.rb --exclude spongewolf/log/*.* --exclude spongewolf/public/source/spongewolf.tar.gz --exclude .svn spongewolf && mv spongewolf.tar.gz #{release_path}/public/source && rm -rf spongewolf"
end
 
task :restart, :roles => :app do
  run "mtr restart #{application} -u #{user} -p #{password}"
  run "mtr generate_htaccess #{application} -u #{user} -p #{password}"
  #migrate
end